From 231aacf8b54582f3c961d7fc53a955506d186769 Mon Sep 17 00:00:00 2001
From: Min Chen <chenm003@163.com>
Date: Tue, 10 Oct 2017 13:14:05 -0500
Subject: [PATCH] [CHEN] Improve by detect imm32hi20 case to reduce ADDI
 instruction

---
 lib/Target/RISCV/RISCVInstrInfo.td |    2 ++
 test/CodeGen/RISCV/calling-conv.ll |    9 +++------
 test/CodeGen/RISCV/vararg.ll       |   12 ++++--------
 3 files changed, 9 insertions(+), 14 deletions(-)

diff --git a/lib/Target/RISCV/RISCVInstrInfo.td b/lib/Target/RISCV/RISCVInstrInfo.td
index b58ee20..9604388 100644
--- a/lib/Target/RISCV/RISCVInstrInfo.td
+++ b/lib/Target/RISCV/RISCVInstrInfo.td
@@ -125,6 +125,7 @@ def ixlenimm : Operand<XLenVT>;
 
 // Standalone (codegen-only) immleaf patterns.
 def simm32 : ImmLeaf<XLenVT, [{return isInt<32>(Imm);}]>;
+def simm32hi20 : ImmLeaf<XLenVT, [{return isShiftedInt<20, 12>(Imm);}]>;
 def simm64 : ImmLeaf<XLenVT, [{return isInt<64>(Imm);}]>;
 
 // Addressing modes.
@@ -377,6 +378,7 @@ class PatGprUimmLog2XLen<SDPatternOperator OpNode, RVInstIShift Inst>
 def : Pat<(simm12:$imm), (ADDI X0, simm12:$imm)>;
 def : Pat<(simm32:$imm), (ADDI (LUI (HI20 imm:$imm)), (LO12Sext imm:$imm))>,
       Requires<[IsRV32]>;
+def : Pat<(simm32hi20:$imm), (LUI (HI20 imm:$imm))>, Requires<[IsRV32]>;
 
 /// Simple arithmetic operations
 
diff --git a/test/CodeGen/RISCV/calling-conv.ll b/test/CodeGen/RISCV/calling-conv.ll
index 381d04a..c00ebfa 100644
--- a/test/CodeGen/RISCV/calling-conv.ll
+++ b/test/CodeGen/RISCV/calling-conv.ll
@@ -40,14 +40,13 @@ define i32 @caller_scalars() {
 ; CHECK: sw ra, 12(sp)
 ; CHECK: sw s0, 8(sp)
 ; CHECK: addi s0, sp, 16
-; CHECK: lui a0, 262464
-; CHECK: addi a6, a0, 0
 ; CHECK: lui a0, %hi(callee_scalars)
 ; CHECK: addi a7, a0, %lo(callee_scalars)
 ; CHECK: addi a0, zero, 1
 ; CHECK: addi a1, zero, 2
 ; CHECK: addi a3, zero, 3
 ; CHECK: addi a4, zero, 4
+; CHECK: lui a6, 262464
 ; CHECK: addi a2, zero, 0
 ; CHECK: addi a5, zero, 0
 ; CHECK: jalr ra, a7, 0
@@ -92,6 +91,8 @@ define i32 @caller_large_scalars() {
 ; CHECK: sw ra, 44(sp)
 ; CHECK: sw s0, 40(sp)
 ; CHECK: addi  s0, sp, 48
+; CHECK: lui a0, 524272
+; CHECK: sw a0, -36(s0)
 ; CHECK: sw zero, -40(s0)
 ; CHECK: sw zero, -44(s0)
 ; CHECK: sw zero, -48(s0)
@@ -100,9 +101,6 @@ define i32 @caller_large_scalars() {
 ; CHECK: sw zero, -20(s0)
 ; CHECK: addi a0, zero, 1
 ; CHECK: sw a0, -24(s0)
-; CHECK: lui a0, 524272
-; CHECK: addi a0, a0, 0
-; CHECK: sw a0, -36(s0)
 ; CHECK: lui a0, %hi(callee_large_scalars)
 ; CHECK: addi a2, a0, %lo(callee_large_scalars)
 ; CHECK: addi a0, s0, -24
@@ -435,7 +433,6 @@ define fp128 @callee_large_scalar_ret() {
 ; CHECK: sw s0, 8(sp)
 ; CHECK: addi s0, sp, 16
 ; CHECK: lui a1, 524272
-; CHECK: addi a1, a1, 0
 ; CHECK: sw a1, 12(a0)
 ; CHECK: sw zero, 8(a0)
 ; CHECK: sw zero, 4(a0)
diff --git a/test/CodeGen/RISCV/vararg.ll b/test/CodeGen/RISCV/vararg.ll
index 73cfa68..251d6b0 100644
--- a/test/CodeGen/RISCV/vararg.ll
+++ b/test/CodeGen/RISCV/vararg.ll
@@ -93,10 +93,9 @@ define i32 @va1_va_arg_alloca(i8* %fmt, ...) {
 
 define void @va1_caller() {
 ; CHECK-LABEL: va1_caller:
-; CHECK: lui a0, 261888
-; CHECK: addi a3, a0, 0
 ; CHECK: lui a0, %hi(va1)
 ; CHECK: addi a0, a0, %lo(va1)
+; CHECK: lui a3, 261888
 ; CHECK: addi a4, zero, 2
 ; CHECK: addi a2, zero, 0
 ; CHECK: jalr ra, a0, 0
@@ -183,10 +182,9 @@ define double @va2_va_arg(i8 *%fmt, ...) {
 
 define void @va2_caller() {
 ; CHECK-LABEL: va2_caller:
-; CHECK: lui a0, 261888
-; CHECK: addi a3, a0, 0
 ; CHECK: lui a0, %hi(va2)
 ; CHECK: addi a0, a0, %lo(va2)
+; CHECK: lui a3, 261888
 ; CHECK: addi a2, zero, 0
 ; CHECK: jalr ra, a0, 0
  %1 = call double (i8*, ...) @va2(i8* undef, double 1.000000e+00)
@@ -285,13 +283,11 @@ define void @va3_caller() {
 ; CHECK: sw ra, 12(sp)
 ; CHECK: sw s0, 8(sp)
 ; CHECK: addi s0, sp, 16
-; CHECK: lui a0, 261888
-; CHECK: addi a2, a0, 0
-; CHECK: lui a0, 262144
-; CHECK: addi a5, a0, 0
 ; CHECK: lui a0, %hi(va3)
 ; CHECK: addi a3, a0, %lo(va3)
 ; CHECK: addi a0, zero, 2
+; CHECK: lui a2, 261888
+; CHECK: lui a5, 262144
 ; CHECK: addi a1, zero, 0
 ; CHECK: addi a4, zero, 0
 ; CHECK: jalr ra, a3, 0
-- 
1.7.9.msysgit.0

